name: Deploy Landing Page

on:
  push:
    branches: [ main, master ]
    paths:
      - 'landing-page/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-landing.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

# Prevent multiple deployments at once
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'landing-page/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./landing-page
      run: npm ci
    
    - name: Run npm audit
      working-directory: ./landing-page
      run: |
        echo "Running npm audit..."
        npm audit --audit-level=moderate || echo "âš ï¸  Vulnerabilities found"
      continue-on-error: true
    
    - name: Run ESLint security checks
      working-directory: ./landing-page
      run: |
        echo "Running ESLint..."
        npm run lint || echo "âš ï¸  Linting issues found"
      continue-on-error: true
    
    - name: Check for hardcoded secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./landing-page
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
      continue-on-error: true
    
    - name: Validate required secrets are set
      run: |
        echo "ðŸ” Checking required secrets..."
        echo ""
        
        MISSING_SECRETS=0
        
        if [ -z "${{ secrets.GOOGLE_SHEETS_CLIENT_EMAIL }}" ]; then
          echo "âŒ GOOGLE_SHEETS_CLIENT_EMAIL secret not set"
          MISSING_SECRETS=1
        else
          echo "âœ… GOOGLE_SHEETS_CLIENT_EMAIL is set"
        fi
        
        if [ -z "${{ secrets.GOOGLE_SHEETS_PRIVATE_KEY }}" ]; then
          echo "âŒ GOOGLE_SHEETS_PRIVATE_KEY secret not set"
          MISSING_SECRETS=1
        else
          echo "âœ… GOOGLE_SHEETS_PRIVATE_KEY is set"
        fi
        
        if [ -z "${{ secrets.GOOGLE_SHEETS_SHEET_ID }}" ]; then
          echo "âŒ GOOGLE_SHEETS_SHEET_ID secret not set"
          MISSING_SECRETS=1
        else
          echo "âœ… GOOGLE_SHEETS_SHEET_ID is set"
        fi
        
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ SSH_PRIVATE_KEY secret not set"
          MISSING_SECRETS=1
        else
          echo "âœ… SSH_PRIVATE_KEY is set"
        fi
        
        if [ -z "${{ secrets.REQUEST_SIGNING_SECRET }}" ]; then
          echo "âš ï¸  REQUEST_SIGNING_SECRET not set (recommended for production)"
        else
          echo "âœ… REQUEST_SIGNING_SECRET is set"
        fi
        
        echo ""
        
        if [ $MISSING_SECRETS -eq 1 ]; then
          echo "âŒ Missing required secrets!"
          echo "Please set all required secrets in GitHub repository settings:"
          echo "Settings > Secrets and variables > Actions > New repository secret"
          exit 1
        fi
        
        echo "âœ… All required secrets are configured"
    
    - name: Security check summary
      if: always()
      run: |
        echo "## ðŸ”’ Security Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Dependency Audit | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| ESLint Security | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Secret Scanning | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Environment Validation | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
  
  build:
    name: Build & Test Docker Image
    runs-on: ubuntu-latest
    needs: security-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      working-directory: ./landing-page
      run: |
        echo "ðŸ”¨ Building Docker image..."
        docker build -t lawcopilot-landing:${{ github.sha }} .
        echo "âœ… Docker image built successfully"
    
    - name: Test Docker image
      run: |
        echo "ðŸ§ª Testing Docker image..."
        echo ""
        
        # Start container
        echo "Starting test container..."
        docker run -d --name test-container \
          -p 3000:3000 \
          -e NODE_ENV=production \
          -e GOOGLE_SHEETS_CLIENT_EMAIL=test@test.com \
          -e GOOGLE_SHEETS_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\ntest\n-----END PRIVATE KEY-----" \
          -e GOOGLE_SHEETS_SHEET_ID=test123 \
          lawcopilot-landing:${{ github.sha }}
        
        # Wait for container to start
        echo "Waiting for container to be healthy..."
        for i in {1..30}; do
          if docker exec test-container node -e "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" 2>/dev/null; then
            echo "âœ… Container is healthy"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Container failed to become healthy"
            docker logs test-container
            exit 1
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
        
        # Test health endpoint
        echo ""
        echo "Testing health endpoint..."
        if curl -f http://localhost:3000/api/health; then
          echo "âœ… Health check passed"
        else
          echo "âŒ Health check failed"
          docker logs test-container
          exit 1
        fi
        
        # Cleanup
        echo ""
        echo "Cleaning up test container..."
        docker stop test-container
        docker rm test-container
        
        echo ""
        echo "âœ… All Docker image tests passed"
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'lawcopilot-landing:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Trivy scan summary
      if: always()
      run: |
        echo "ðŸ” Running detailed Trivy scan for summary..."
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image \
          --severity HIGH,CRITICAL \
          --format table \
          lawcopilot-landing:${{ github.sha }} || echo "Vulnerabilities found"
    
    - name: Build summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Container Test | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        echo "| Health Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag:** \`lawcopilot-landing:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Build Time:** \`$(date -u)\`" >> $GITHUB_STEP_SUMMARY
  
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [security-checks, build]
    environment:
      name: production
      url: https://lawcopilot.io
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy Landing Page to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 154.210.208.214
        port: 22278
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script_stop: true
        script: |
          set -e
          
          echo "ðŸš€ Starting deployment to production..."
          echo "================================================"
          echo ""
          
          cd /opt/lawcopilot
          
          echo "ðŸ” Checking deployment prerequisites..."
          
          # Check if deploy script exists
          if [ ! -f "./deploy.sh" ]; then
            echo "âŒ deploy.sh not found!"
            exit 1
          fi
          echo "âœ… deploy.sh found"
          
          # Make deploy script executable
          chmod +x ./deploy.sh
          
          # Check if docker-compose.yml exists
          if [ ! -f "./docker-compose.yml" ]; then
            echo "âŒ docker-compose.yml not found!"
            exit 1
          fi
          echo "âœ… docker-compose.yml found"
          
          # Check if Docker is running
          if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker is not running!"
            exit 1
          fi
          echo "âœ… Docker is running"
          
          echo ""
          echo "ðŸ“¦ Current deployment status:"
          docker-compose ps || echo "No containers running"
          
          echo ""
          echo "ðŸ”„ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          
          echo ""
          echo "ðŸš€ Starting deployment..."
          ./deploy.sh landing
          
          echo ""
          echo "â³ Waiting for service to be healthy..."
          sleep 15
          
          # Verify deployment
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
              echo ""
              echo "ðŸ“‹ Container logs:"
              docker-compose logs --tail=50 app
              exit 1
            fi
            
            echo "Waiting for health check... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 3
          done
          
          echo ""
          echo "ðŸ“Š Deployment status:"
          docker-compose ps
          
          echo ""
          echo "ðŸŽ‰ Deployment successful!"
          echo "================================================"
    
    - name: Post-deployment verification
      if: success()
      run: |
        echo "ðŸ” Running post-deployment verification..."
        echo ""
        
        # Wait a bit for full startup
        sleep 5
        
        # Check if production site is accessible
        echo "Testing production site..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://lawcopilot.io || echo "000")
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 304 ]; then
          echo "âœ… Production site is accessible (HTTP $HTTP_CODE)"
        else
          echo "âš ï¸  Production site returned HTTP $HTTP_CODE"
          echo "This might be normal if SSL is still propagating"
        fi
        
        echo ""
        echo "âœ… Post-deployment verification complete"
    
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "## ðŸŽ‰ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The landing page has been successfully deployed to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://lawcopilot.io |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed At | \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸ’¥ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment encountered an error. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Failed At:** \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo ""
        echo "To investigate:"
        echo "1. Check the logs above for error details"
        echo "2. SSH into the server to check container status"
        echo "3. Review recent commits for potential issues"

  rollback:
    name: Rollback Instructions
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
    - name: Provide rollback instructions
      run: |
        echo "## âš ï¸  Deployment Failed - Rollback Instructions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To rollback the deployment, follow these steps:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Option 1: SSH Rollback" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "ssh -p 22278 root@154.210.208.214" >> $GITHUB_STEP_SUMMARY
        echo "cd /opt/lawcopilot" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Stop current deployment" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose down" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Rollback to previous commit" >> $GITHUB_STEP_SUMMARY
        echo "git log --oneline -5  # Find the previous working commit" >> $GITHUB_STEP_SUMMARY
        echo "git checkout <previous-commit-hash>" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Redeploy" >> $GITHUB_STEP_SUMMARY
        echo "./deploy.sh landing" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Option 2: Re-run Previous Workflow" >> $GITHUB_STEP_SUMMARY
        echo "Go to Actions tab and re-run the last successful deployment workflow." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Verification" >> $GITHUB_STEP_SUMMARY
        echo "After rollback, verify the site is working:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "curl http://localhost:3000/api/health" >> $GITHUB_STEP_SUMMARY
        echo "curl https://lawcopilot.io" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    
    steps:
    - name: Cleanup Docker resources on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 154.210.208.214
        port: 22278
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ðŸ§¹ Cleaning up old Docker resources..."
          
          # Remove dangling images
          docker image prune -f
          
          # Remove unused containers
          docker container prune -f
          
          # Show disk usage
          echo ""
          echo "ðŸ“Š Current Docker disk usage:"
          docker system df
          
          echo ""
          echo "âœ… Cleanup complete"